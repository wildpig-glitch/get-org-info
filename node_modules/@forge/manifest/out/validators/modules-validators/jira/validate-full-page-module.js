"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.validateJiraFullPageModule = void 0;
const types_1 = require("../../../types");
const text_1 = require("../../../text");
const utils_1 = require("../../../utils");
const VALID_ROUTE_PATTERN = new RegExp(/^[a-z0-9\\-]+$/);
const ROUTE_FULL_PAGE = 'routePrefix';
const errorMessages = text_1.errors.modules.jiraFullPageModule;
const mapToFullPageError = (validationErrors, moduleKey) => validationErrors.map((message) => ({ moduleKey, message }));
const validateRegex = (pattern, moduleKey, index) => {
    const validationErrors = [];
    if (!VALID_ROUTE_PATTERN.test(pattern)) {
        validationErrors.push(errorMessages.invalidRouteRegex(pattern, moduleKey, index));
    }
    return validationErrors;
};
const validateRoute = (moduleKey, pattern, index) => {
    const validationErrors = [];
    validationErrors.push(...validateRegex(pattern, moduleKey, index));
    return mapToFullPageError(validationErrors, moduleKey);
};
const validatePropertyUniqueness = (allModules, moduleType, property, yamlContentByLine) => {
    const validationErrors = [];
    const modules = allModules[moduleType] || [];
    const allPropertyValues = modules.map((module) => module[property]).filter((property) => property);
    const duplicatePropertyValues = allPropertyValues.filter((property, index, all) => all.indexOf(property) !== index);
    if (duplicatePropertyValues.length > 0) {
        const allModulesWithDuplicatedPropertyValues = modules.filter((module) => module[property] === duplicatePropertyValues[0]);
        validationErrors.push({
            message: text_1.errors.modules.jiraFullPageModule.propertyUniqueness(property, moduleType, duplicatePropertyValues),
            reference: text_1.References.Modules,
            level: 'error',
            ...(0, utils_1.findPosition)(allModulesWithDuplicatedPropertyValues?.[0]?.key, yamlContentByLine)
        });
    }
    return validationErrors;
};
const validateJiraFullPageModule = (modules, yamlContentByLine) => {
    const validationErrors = [];
    const moduleType = types_1.AllModuleTypes.JiraFullPage;
    const fullPageModules = modules[moduleType] || [];
    validationErrors.push(...validatePropertyUniqueness(modules, moduleType, ROUTE_FULL_PAGE, yamlContentByLine));
    if (validationErrors.length) {
        return validationErrors;
    }
    fullPageModules.forEach((module, index) => {
        validationErrors.push(...validateRoute(module.key, module.routePrefix, index).map((error) => ({
            message: error.message,
            reference: text_1.References.Modules,
            level: 'error',
            ...(0, utils_1.findPosition)(error.moduleKey, yamlContentByLine)
        })));
    });
    return validationErrors;
};
exports.validateJiraFullPageModule = validateJiraFullPageModule;
